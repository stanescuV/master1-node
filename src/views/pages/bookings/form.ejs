<%- include('../../partials/head', { title: booking ? 'Modifier la reservation' : 'Nouvelle reservation' }) %>

<body class="bg-gray-100 min-h-screen flex flex-col">
  <%- include('../../partials/header') %>

  <main class="container mx-auto py-8 px-4 grow">
    <a href="/bookings" class="inline-flex items-center gap-1 text-blue-500 hover:text-blue-700 mb-6">
      <%- icon('ArrowLeft', { size: 18 }) %>
      Retour a la liste
    </a>

    <div class="bg-white rounded-lg shadow-lg p-8 max-w-2xl">
      <h1 class="text-3xl font-bold text-gray-800 mb-6">
        <%= booking ? 'Modifier la reservation' : 'Nouvelle reservation' %>
      </h1>

      <% if (typeof errors !== 'undefined' && errors && errors.length > 0) { %>
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">
          <p class="font-bold">Erreurs de validation :</p>
          <ul class="list-disc list-inside mt-2">
            <% errors.forEach(error => { %>
              <li><%= error.message %></li>
            <% }) %>
          </ul>
        </div>
      <% } %>

      <% if (typeof conflictError !== 'undefined' && conflictError) { %>
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">
          <p><%= conflictError %></p>
        </div>
      <% } %>

      <form method="POST" action="<%= booking ? '/bookings/' + booking.id + '/edit' : '/bookings/new' %>" class="space-y-6">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="stationId" class="block text-gray-700 font-medium mb-2">Station *</label>
            <select
              id="stationId"
              name="stationId"
              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              required
            >
              <option value="">Selectionnez une station</option>
              <% stations.forEach(station => { %>
                <% const selectedStationId = (typeof formData !== 'undefined' && formData.stationId) || (booking && booking.stationId) %>
                <option value="<%= station.id %>" <%= selectedStationId == station.id ? 'selected' : '' %>>
                  <%= station.name %> (<%= station.status %>)
                </option>
              <% }) %>
            </select>
          </div>
          <div>
            <label for="userId" class="block text-gray-700 font-medium mb-2">Utilisateur *</label>
            <select
              id="userId"
              name="userId"
              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              required
            >
              <option value="">Selectionnez un utilisateur</option>
              <% users.forEach(u => { %>
                <% const selectedUserId = (typeof formData !== 'undefined' && formData.userId) || (booking && booking.userId) %>
                <option value="<%= u.id %>" <%= selectedUserId == u.id ? 'selected' : '' %>>
                  <%= u.username %> (<%= u.email %>)
                </option>
              <% }) %>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="startTime" class="block text-gray-700 font-medium mb-2">Date et heure de debut *</label>
            <input
              type="datetime-local"
              id="startTime"
              name="startTime"
              value="<%= (typeof formData !== 'undefined' && formData.startTime) || (booking && new Date(booking.startTime).toISOString().slice(0, 16)) || '' %>"
              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              required
            >
          </div>
          <div>
            <label for="endTime" class="block text-gray-700 font-medium mb-2">Date et heure de fin *</label>
            <input
              type="datetime-local"
              id="endTime"
              name="endTime"
              value="<%= (typeof formData !== 'undefined' && formData.endTime) || (booking && new Date(booking.endTime).toISOString().slice(0, 16)) || '' %>"
              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              required
            >
          </div>
        </div>

        <div>
          <label for="status" class="block text-gray-700 font-medium mb-2">Statut</label>
          <select
            id="status"
            name="status"
            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
            <% const currentStatus = (typeof formData !== 'undefined' && formData.status) || (booking && booking.status) || 'confirmed' %>
            <option value="confirmed" <%= currentStatus === 'confirmed' ? 'selected' : '' %>>Confirmee</option>
            <option value="cancelled" <%= currentStatus === 'cancelled' ? 'selected' : '' %>>Annulee</option>
            <option value="completed" <%= currentStatus === 'completed' ? 'selected' : '' %>>Terminee</option>
          </select>
        </div>

        <div class="flex gap-4">
          <button
            type="submit"
            class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-6 rounded-lg transition-colors"
          >
            <%= booking ? 'Enregistrer' : 'Creer' %>
          </button>
          <a
            href="/bookings"
            class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-6 rounded-lg transition-colors"
          >
            Annuler
          </a>
        </div>
      </form>
    </div>
  </main>

  <%- include('../../partials/footer') %>
</body>
</html>
